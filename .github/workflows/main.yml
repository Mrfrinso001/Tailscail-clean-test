name: Tailscale Ghost Cleaner
on:
  workflow_dispatch:

jobs:
  ghost-clean:
    runs-on: ubuntu-latest
    steps:
      - name: Clean ghosts
        run: |
          tailnet="taila2a6d7.ts.net"
          machines_url="https://api.tailscale.com/api/v2/tailnet/$tailnet/machines"

          echo "ðŸ“¡ Fetching machines..."
          resp=$(curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" "$machines_url")

          echo "$resp" | jq '.machines[] | {hostname, id, lastSeen}'

          ids=$(echo "$resp" | jq -r '.machines[] | select(.hostname | startswith("rdp-ci-node")) | .id')

          if [ -z "$ids" ]; then
            echo "âœ… No rdp-ci-node machines found."; exit 0
          fi

          newest=$(echo "$resp" | jq -r '.machines | map(select(.hostname | startswith("rdp-ci-node"))) | max_by(.lastSeen).id')

          for id in $ids; do
            if [ "$id" != "$newest" ]; then
              echo "ðŸ—‘ Deleting ghost $id"
              curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" -X DELETE "https://api.tailscale.com/api/v2/device/$id"
            else
              echo "Keeping newest $id"
            fi
          done

          echo "ðŸ“‹ Remaining devices:"
          curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" "$machines_url" | jq '.machines[] | {hostname, id, lastSeen}'
        env:
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
